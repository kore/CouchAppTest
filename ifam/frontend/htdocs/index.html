<?xml version="1.0"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:html="http://www.w3.org/1999/xhtml"
    xml:lang="en"
    lang="en">
<html:head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>IFAM - CouchDB example</title>

    <link rel="Stylesheet" type="text/css" href="/styles/screen.css" media="screen" />

    <link rel="icon" href="/images/favicon.png" type="image/png" />

    <script type="text/javascript" src="/scripts/jquery-1.4.2.min.js"></script>
    <script type="text/javascript">
// <![CDATA[

function myQuery( url, callback, data, method )
{
    var data   = ( data   === undefined ) ? null : data;
    var method = ( method === undefined ) ? "GET" : method;

    $.ajax( {
        type: method,
        url: "/api" + url,
        data: data,
        success: callback,
        error: function( request, textStatus, error )
            {
                var result = JSON.parse( request.responseText );
                console.log( "Error loggin in: " + result.reason );
                throw( result );
            },
        dataType: "json",
        contentType: "application/json",
    } );
}

function refreshUserList()
{
    $( 'ul#users' ).empty();
    myQuery(
        "/_design/ifam/_view/users?include_docs=true",
        function ( data, textStatus, jqXHR ) {
            $.each( data.rows, function( key, value ) {
                $( 'ul#users' ).append( "<li>"+ value.doc.name + " &lt;" + value.doc.email + "&gt;</li>" );
            } )
        }
    );
}

// @TODO: extract application.js, extract user create function.
$( document ).ready( function() {

    $( "#createUser" ).bind( "submit", function() {

        // function myQuery( url, callback, data, method )
        myQuery(
            "/" + $( 'input[name="name"]' ).val(),
            function ( data, textStatus, jqXHR ) {
                console.log( data );
                refreshUserList();
            },
            JSON.stringify( {
                name: $( 'input[name="name"]' ).val(),
                email: $( 'input[name="email"]' ).val(),
                type: "user"
            } ),
            "PUT"
        );

        return false;
    } );

    refreshUserList();
} );

// ]]>
    </script>
</head>
<body>
    <h1>IFAM example app</h1>

    <div id="content">
        <h2>Welcome</h2>
        <p>This is a small example application, which allows you to manage usersâ€¦</p>
        <ul>
            <li>Manipulate DOM tree with JavaScript</li>
            <li>Read document from CouchDB</li>
            <li>Create document in CouchDB</li>
            <li>List documents</li>
            <li>Display a single document</li>
        </ul>
        <h3>Users</h3>
        <ul id="users">
        </ul>
        <fieldset>
            <form id="createUser">
                <input type="text" name="name" />
                <input type="text" name="email" />
                <input type="submit" value="Create" />
            </form>
        </fieldset>
    </div>
</body>
</html>
